apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "arkd.fullname" . }}
  labels:
    {{- include "arkd.labels" . | nindent 4 }}
spec:
  {{- if not .Values.arkd.autoscaling.enabled }}
  replicas: {{ .Values.arkd.replicaCount }}
  {{- end }}
  selector:
    matchLabels:
      {{- include "arkd.selectorLabels" . | nindent 6 }}
  template:
    metadata:
      {{- with .Values.arkd.podAnnotations }}
      annotations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      labels:
        {{- include "arkd.labels" . | nindent 8 }}
        {{- with .Values.arkd.podLabels }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
    spec:
      {{- with .Values.arkd.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      serviceAccountName: {{ include "arkd.serviceAccountName" . }}
      {{- with .Values.arkd.podSecurityContext }}
      securityContext:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      containers:
        - name: {{ .Chart.Name }}
          {{- with .Values.arkd.securityContext }}
          securityContext:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          image: "{{ .Values.arkd.image.repository }}:{{ .Values.arkd.image.tag | default .Chart.AppVersion }}"
          imagePullPolicy: {{ .Values.arkd.image.pullPolicy }}
          ports:
            - name: arkd
              containerPort: {{ .Values.arkd.service.targetPort }}
              protocol: TCP
          env:
            - name: ARKD_DATADIR
              value: "/app/data"
            - name: ARKD_PORT
              value: {{ .Values.arkd.service.targetPort | quote }}
            - name: ARKD_LOG_LEVEL
              value: {{ .Values.arkd.logLevel | quote }}
            - name: ARKD_ROUND_INTERVAL
              value: {{ .Values.arkd.roundInterval | quote }}
            - name: ARKD_DB_TYPE
              value: {{ .Values.arkd.database.type | quote }}
            - name: ARKD_PG_DB_URL
              {{- if and .Values.arkd.database.existingSecret .Values.arkd.database.existingSecretKey }}
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.arkd.database.existingSecret }}
                  key: {{ .Values.arkd.database.existingSecretKey }}
              {{- else }}
              value: {{ .Values.arkd.database.url | quote }}
              {{- end }}
            - name: ARKD_EVENT_DB_TYPE
              value: {{ .Values.arkd.database.event.type| quote }}
            - name: ARKD_PG_EVENT_DB_URL
              {{- if and .Values.arkd.database.event.existingSecret .Values.arkd.database.event.existingSecretKey }}
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.arkd.database.event.existingSecret }}
                  key: {{ .Values.arkd.database.event.existingSecretKey }}
              {{- else }}
              value: {{ .Values.arkd.database.event.url | quote }}
              {{- end }}
            - name: ARKD_TX_BUILDER_TYPE
              value: {{ .Values.arkd.txBuilderType | quote }}
            - name: ARKD_LIVE_STORE_TYPE
              value: {{ .Values.arkd.livestore.type | quote }}
            - name: ARKD_REDIS_URL
              {{- if and .Values.arkd.livestore.existingSecret .Values.arkd.livestore.existingSecretKey }}
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.arkd.livestore.existingSecret }}
                  key: {{ .Values.arkd.livestore.existingSecretKey }}
              {{- else }}
              value: {{ .Values.arkd.livestore.url | quote }}
              {{- end }}
            - name: ARKD_VTXO_TREE_EXPIRY
              value: {{ .Values.arkd.vtxo.treeExpiry | quote }}
            - name: ARKD_UNILATERAL_EXIT_DELAY
              value: {{ .Values.arkd.unilateralExitDelay | quote }}
            - name: ARKD_BOARDING_EXIT_DELAY
              value: {{ .Values.arkd.boardingExitDelay | quote }}
            - name: ARKD_ESPLORA_URL
              value: {{ .Values.arkd.esploraUrl | quote }}
            - name: ARKD_WALLET_ADDR
              value: {{ printf "%s:%d" (include "arkdwallet.fullname" .) (int .Values.arkdwallet.service.targetPort) | quote }}
            - name: ARKD_NO_MACAROONS
              value: {{ .Values.arkd.noMacaroons | quote }}
            - name: ARKD_NO_TLS
              value: {{ .Values.arkd.noTls | quote }}
            - name: ARKD_UNLOCKER_TYPE
              value: {{ .Values.arkd.unlocker.type | quote }}
            - name: ARKD_UNLOCKER_FILE_PATH
              value: {{ .Values.arkd.unlocker.filePath | quote }}
            - name: ARKD_UNLOCKER_PASSWORD
              {{- if and .Values.arkd.unlocker.existingSecret .Values.arkd.unlocker.existingSecretKey }}
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.arkd.unlocker.existingSecret }}
                  key: {{ .Values.arkd.unlocker.existingSecretKey }}
              {{- else }}
              value: {{ .Values.arkd.unlocker.password | quote }}
              {{- end }}
            - name: ARKD_ROUND_MAX_PARTICIPANTS_COUNT
              value: {{ .Values.arkd.round.maxParticipantsCount | quote }}
            - name: ARKD_ROUND_MIN_PARTICIPANTS_COUNT
              value: {{ .Values.arkd.round.minParticipantsCount | quote }}
            - name: ARKD_UTXO_MAX_AMOUNT
              value: {{ .Values.arkd.utxo.maxAmount | quote }}
            - name: ARKD_UTXO_MIN_AMOUNT
              value: {{ .Values.arkd.utxo.minAmount | quote }}
            - name: ARKD_VTXO_MAX_AMOUNT
              value: {{ .Values.arkd.vtxo.maxAmount | quote }}
            - name: ARKD_VTXO_MIN_AMOUNT
              value: {{ .Values.arkd.vtxo.minAmount | quote }}
          {{- with .Values.arkd.livenessProbe }}
          livenessProbe:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          {{- with .Values.arkd.readinessProbe }}
          readinessProbe:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          {{- with .Values.arkd.resources }}
          resources:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          volumeMounts:
            - name: data
              mountPath: /app/data
      volumes:
        - name: data
          {{- if not .Values.arkd.persistence.enabled }}
          emptyDir: {}
          {{- else if .Values.arkd.persistence.existingClaim | default "" | ne "" }}
          persistentVolumeClaim:
            claimName: {{ .Values.arkd.persistence.existingClaim }}
          {{- else }}
          persistentVolumeClaim:
            claimName: {{ include "arkd.fullname" . }}-pvc
          {{- end }}
      {{- with .Values.arkd.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.arkd.affinity }}
      affinity:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.arkd.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}